
# 操作系统接口

操作系统的任务是在多个程序之间共享计算机并提供比硬件本身更有用的服务。操作系统管理并抽象出低级硬件。通过这种方式，例如像文字处理程序这一类应用程序就不必关心所使用的磁盘硬件类型。操作系统在多个程序之间共享硬件，以便它们同时运行（或看似运行）。最后，操作系统为程序提供了可控的交互方式，使它们可以共享数据或协同工作。

操作系统通过接口为用户程序提供服务。设计一个好的接口非常困难。一方面，我们希望系统接口简洁，因为这样更容易正确实现。另一方面，我们可能会受到诱惑，为应用程序提供许多复杂的功能。解决这一矛盾的诀窍在于设计依赖于少数机制的接口，而这些机制可以组合起来提供更多的通用性。

本书使用一个操作系统作为具体示例来说明操作系统的概念。这个名为 xv6 的操作系统提供了肯.汤普森和丹尼斯.里奇的 Unix 操作系统引入的基本接口，并模仿 Unix 的内部设计。Unix 提供了很少的接口，其机制结合得很好，提供了令人惊讶的通用性。这种接口非常成功，以至于现代操作系统--BSD、Linux、macOS、Solaris，甚至微软的 Windows--都有类似 Unix 的接口。了解 xv6 是了解这些系统和许多其他系统的良好开端。

如图 1.1 所示，xv6 采用内核的传统形式，内核是一个为运行程序提供服务的特殊程序。每个运行中的程序都被称为进程，拥有包含指令、数据和堆栈的内存。指令实现程序的计算。数据是计算所依据的变量。堆栈组织程序的过程调用。一台计算机通常有许多进程，但只有一个内核。

当一个进程需要调用内核服务时，它会调用系统调用，即操作系统接口中的一个调用。系统调用进入内核；内核执行服务并返回。因此，进程在用户空间和内核空间交替执行。内核利用 CPU 提供的硬件保护机制，确保在用户空间执行的每个进程只能访问自己的内存。内核在执行时拥有实施这些保护所需的硬件权限；用户程序在执行时则没有这些权限。当用户程序调用系统调用时，硬件会提高权限级别，并开始执行内核中预先安排的函数。

内核提供的系统调用集合就是用户程序看到的接口。xv6 内核提供了 Unix 内核传统服务和系统调用的子集。图 1.2 列出了 xv6 的所有系统调用。

本章其余部分将概述 xv6 的服务--进程、内存、文件描述符、管道和文件系统，并通过代码片段和讨论 shell（Unix 的命令行用户界面）如何使用这些服务来加以说明。shell 对系统调用的使用说明了系统调用是如何精心设计的。

shell 是一个普通程序，它读取用户的命令并执行这些命令。shell 是一个用户程序，而不是内核的一部分，这一事实说明了系统调用接口的强大功能：shell 并没有什么特别之处。这也意味着 shell 很容易更换；因此，现代 Unix 系统有多种 shell 可供选择，每种 shell 都有自己的用户界面和脚本功能。xv6 shell 是 Unix Bourne shell 精髓的简单实现。其实现可参见 (user/sh.c:1)。

## 1.1 进程与内存

xv6 进程由用户空间内存（指令、数据和堆栈）和内核私有的每个进程状态组成。Xv6 实现了进程的时间共享：它会在等待执行的进程集合之间透明地切换可用的 CPU。当进程不执行时，xv6 会保存其 CPU 寄存器，并在下一次运行进程时恢复这些寄存器。内核会为每个进程关联一个进程标识符（PID）。

